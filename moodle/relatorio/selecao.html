<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <title>Selecionar Cursos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="../../extra/css/principal.css" />
</head>

<body>
  <div class="container py-5">

    <div class="row mb-4 align-items-center">
      <div class="col">
        <h1 class="h2 mb-0">
          <i class="bi bi-list-check me-2"></i>Selecionar Cursos
        </h1>
        <div class="small text-muted" id="identificacao" hidden></div>
      </div>
      <div class="col-auto">
        <a href="lista_relatorios.html" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i> Voltar
        </a>
      </div>
    </div>

    <div id="alerta" class="alert d-none" role="alert" aria-live="polite"></div>

    <form id="formCursos">
      <p class="text-muted">
        Selecione os cursos que deseja incluir no relatório:
      </p>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="selecionarTodos" />
        <label class="form-check-label" for="selecionarTodos">
          Selecionar Todos
        </label>
      </div>

      <div id="listaCursos" class="mb-4"></div>

      <button type="submit" class="btn btn-danger btn-lg">
        <i class="bi bi-bar-chart-line me-2"></i>Visualizar Relatório
      </button>
    </form>

  </div>

  <script src="../../extra/js/logout.js"></script>
  <script src="../../extra/js/fetchComToken.js"></script>
  <script src="../../extra/js/refreshAccessToken.js"></script>
  <script src="../../extra/js/verificarTokenERedirecionar.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (!id) {
      document.getElementById("alerta").className = "alert alert-danger";
      document.getElementById("alerta").textContent = "ID do relatório não informado.";
      document.getElementById("alerta").classList.remove("d-none");
    }

    async function carregarCursos() {
      const lista = document.getElementById("listaCursos");
      lista.innerHTML = `<div class="text-muted"><div class="spinner-border spinner-border-sm me-2"></div>Carregando cursos...</div>`;

      try {
        let resp = await fetchComToken(`/backend/moodle/relatorio/selecao/${id}/`, { method: "GET" });

        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken(`/backend/moodle/relatorio/selecao/${id}/`, { method: "GET" });
        }

        if (!resp.ok) {
          throw new Error("Erro ao buscar cursos disponíveis.");
        }

        const dados = await resp.json();
        lista.innerHTML = "";

        if (!dados.length) {
          lista.innerHTML = `<div class="alert alert-info">Nenhum curso encontrado neste relatório.</div>`;
          return;
        }

        dados.forEach((curso) => {
          lista.insertAdjacentHTML(
            "beforeend",
            `
            <div class="form-check mb-2">
              <input class="form-check-input curso-checkbox" type="checkbox" 
                     value="${curso.ac_curso_oferta__ac_curso__id}" 
                     id="curso_${curso.ac_curso_oferta__ac_curso__id}">
              <label class="form-check-label" for="curso_${curso.ac_curso_oferta__ac_curso__id}">
                ${curso.ac_curso_oferta__ac_curso__nome}
              </label>
            </div>
            `
          );
        });
      } catch (e) {
        lista.innerHTML = "";
        const alerta = document.getElementById("alerta");
        alerta.className = "alert alert-danger";
        alerta.textContent = e.message;
        alerta.classList.remove("d-none");
      }
    }

    document.getElementById("selecionarTodos").addEventListener("change", function () {
      document.querySelectorAll(".curso-checkbox").forEach(chk => chk.checked = this.checked);
    });

    document.getElementById("formCursos").addEventListener("submit", function (e) {
      e.preventDefault();
      const selecionados = Array.from(document.querySelectorAll(".curso-checkbox:checked")).map(el => el.value);

      if (!selecionados.length) {
        alert("Selecione ao menos um curso.");
        return;
      }

      const cursosParam = encodeURIComponent(selecionados.join(","));
      window.location.href = `relatorio.html?id=${id}&cursos=${cursosParam}`;
    });

    document.addEventListener("DOMContentLoaded", carregarCursos);
  </script>
</body>

</html>