<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Editais para Validação</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="../../extra/css/principal.css" />
</head>

<body>
    <div class="container py-5">

        <!-- Cabeçalho -->
        <div class="row mb-4 align-items-center">
            <div class="col">
                <h1 class="h2 mb-0">
                    <i class="bi bi-journal-check me-2"></i>Editais para Validação
                </h1>
            </div>
            <div class="col-auto d-flex gap-2">
                <a href="/" class="btn btn-outline-primary">
                    <i class="bi bi-list me-1"></i> Menu
                </a>
                <button class="btn btn-outline-danger" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i> Sair
                </button>
            </div>
        </div>

        <!-- Alert -->
        <div id="status" class="alert d-none" role="alert"></div>

        <!-- Tabela -->
        <div class="table-responsive shadow-sm">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">Número</th>
                        <th class="text-center">Ano</th>
                        <th>Descrição</th>
                        <th class="text-center">Data de validade</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody id="tbody-editais">
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">Carregando editais...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../extra/js/logout.js"></script>
    <script src="../../extra/js/fetchComToken.js"></script>
    <script src="../../extra/js/refreshAccessToken.js"></script>
    <script>
        function showStatus(msg, type = "danger") {
            const el = document.getElementById("status");
            el.className = `alert alert-${type}`;
            el.textContent = msg;
            el.classList.remove("d-none");
        }

        function clearStatus() {
            const el = document.getElementById("status");
            el.className = "alert d-none";
            el.textContent = "";
        }

        const fmtData = (d) => {
            try { return new Date(d).toLocaleDateString("pt-BR"); }
            catch { return "-"; }
        };

        async function carregarEditais() {
            const tbody = document.getElementById("tbody-editais");
            clearStatus();
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Carregando editais...</td></tr>`;

            try {
                let resp = await fetchComToken("/backend/editais/validar/", {
                    method: "GET",
                    credentials: "include",
                });

                if (resp.status === 401) {
                    await refreshAccessToken();
                    resp = await fetchComToken("/backend/editais/validar/", {
                        method: "GET",
                        credentials: "include",
                    });
                }

                if (!resp.ok) throw new Error("Erro ao buscar editais.");

                const editais = await resp.json();
                tbody.innerHTML = "";

                if (!Array.isArray(editais) || editais.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Nenhum edital disponível para validação.</td></tr>`;
                    return;
                }

                editais.forEach((e) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
            <td class="text-center">${e.numero ?? "-"}</td>
            <td class="text-center">${e.ano ?? "-"}</td>
            <td>${e.descricao ?? "-"}</td>
            <td class="text-center">${e.data_validade ? fmtData(e.data_validade) : "-"}</td>
            <td class="text-end">
              <a href="listar_vagas.html?ano=${encodeURIComponent(e.ano)}&numero=${encodeURIComponent(e.numero)}"
                 class="btn btn-danger btn-sm">
                <i class="bi bi-eye"></i> Ver Vagas
              </a>
            </td>
          `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                showStatus(err.message || "Falha ao carregar editais.");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem("token");
            if (!token) return logout();
            carregarEditais();
        });
    </script>
</body>

</html>