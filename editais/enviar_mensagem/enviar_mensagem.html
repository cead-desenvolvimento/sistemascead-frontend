<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Envio de mensagem para candidatos</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="../../extra/css/principal.css" />
</head>

<body>
  <div class="container py-5">

    <!-- Cabeçalho -->
    <div class="row mb-4 align-items-center">
      <div class="col">
        <h1 class="h2 mb-0">
          <i class="bi bi-people-fill me-2"></i>Envio de mensagem para candidatos
        </h1>
      </div>
      <div class="col-auto d-flex gap-2">
        <a href="listar_editais.html" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i> Voltar
        </a>
        <button class="btn btn-outline-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right me-1"></i> Sair
        </button>
      </div>
    </div>

    <!-- Alert global -->
    <div id="status" class="alert d-none" role="alert" aria-live="polite"></div>

    <!-- Envio em lote -->
    <div class="card shadow-sm mb-4">
      <div class="card-header">
        <i class="bi bi-envelope me-2"></i>Envio em lote
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-8">
            <label for="select-email-ate" class="form-label">Enviar e-mail até o candidato:</label>
            <select id="select-email-ate" class="form-select">
              <option value="">Selecione um candidato</option>
            </select>
          </div>
          <div class="col-md-4">
            <button id="btn-enviar-emails" class="btn btn-danger w-100" type="button">
              <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
              <i class="bi bi-send me-1"></i><span>Enviar e-mails</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista de candidatos -->
    <div class="card shadow-sm">
      <div class="card-header">
        <i class="bi bi-list-ul me-2"></i>Lista de candidatos
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Nome</th>
                <th>E-mail</th>
                <th class="text-center">Pontuação</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody id="candidatos-list">
              <tr>
                <td colspan="4" class="text-center py-4 text-muted">Carregando candidatos...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts comuns -->
  <script src="../../extra/js/logout.js"></script>
  <script src="../../extra/js/fetchComToken.js"></script>
  <script src="../../extra/js/refreshAccessToken.js"></script>

  <script>
    let vagaId = null;
    let candidatos = [];

    function showStatus(message, type = "danger") {
      const el = document.getElementById("status");
      el.className = `alert alert-${type}`;
      el.textContent = message;
      el.classList.remove("d-none");
      el.scrollIntoView({ behavior: "smooth", block: "start" });
    }
    function clearStatus() {
      const el = document.getElementById("status");
      el.className = "alert d-none";
      el.textContent = "";
    }

    async function carregarCandidatos() {
      const params = new URLSearchParams(window.location.search);
      vagaId = params.get("vaga");
      const tbody = document.getElementById("candidatos-list");
      const selectEmailAte = document.getElementById("select-email-ate");

      if (!vagaId) {
        showStatus("Parâmetro inválido na URL.");
        return;
      }

      clearStatus();
      tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">Carregando candidatos...</td></tr>`;
      selectEmailAte.innerHTML = '<option value="">Selecione um candidato</option>';

      try {
        let resp = await fetchComToken(`/backend/editais/enviar_mensagem/vaga/${vagaId}/`, {
          method: "GET",
          credentials: "include",
        });

        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken(`/backend/editais/enviar_mensagem/vaga/${vagaId}/`, {
            method: "GET",
            credentials: "include",
          });
        }

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.error || err.detail || "Erro ao buscar candidatos.");
        }

        candidatos = await resp.json();
        tbody.innerHTML = "";

        if (!Array.isArray(candidatos) || candidatos.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">Nenhum candidato disponível.</td></tr>`;
          return;
        }

        for (const cand of candidatos) {
          const pontuacao = cand.pontuacao != null ? cand.pontuacao : 0;
          const email = cand.pessoa_email || "";
          const nome = cand.pessoa_nome || "-";

          // linha da tabela
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${nome}</td>
            <td>${email}</td>
            <td class="text-center">${pontuacao}</td>
            <td class="text-end">
              <button class="btn btn-danger btn-sm" type="button" data-email="${email}">
                <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                <i class="bi bi-envelope me-1"></i><span>Enviar</span>
              </button>
            </td>
          `;
          tbody.appendChild(tr);

          // option do select
          if (email) {
            const opt = document.createElement("option");
            opt.value = email;
            opt.textContent = nome;
            selectEmailAte.appendChild(opt);
          }
        }

        // bind dos botões "Enviar" (individual)
        tbody.querySelectorAll("button[data-email]").forEach((btn) => {
          btn.addEventListener("click", () => enviarEmail(btn.dataset.email, btn));
        });

      } catch (e) {
        showStatus(e.message || "Falha ao carregar candidatos.");
      }
    }

    async function enviarEmail(email, botaoEl) {
      if (!email) return showStatus("E-mail inválido para envio.");

      const spinner = botaoEl.querySelector(".spinner-border");
      const label = botaoEl.querySelector("span:last-child");
      botaoEl.disabled = true; spinner.classList.remove("d-none"); label.textContent = "Enviando...";

      try {
        let resp = await fetchComToken(`/backend/editais/enviar_email/${encodeURIComponent(email)}/`, {
          method: "GET",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
        });

        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken(`/backend/editais/enviar_email/${encodeURIComponent(email)}/`, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
          });
        }

        const result = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(result.detail || "Erro ao enviar e-mail.");

        showStatus(result.detail || "E-mail enviado com sucesso.", "success");
      } catch (e) {
        showStatus(e.message || "Falha ao enviar e-mail.");
      } finally {
        spinner.classList.add("d-none"); label.textContent = "Enviar"; botaoEl.disabled = false;
      }
    }

    async function enviarEmailsLote() {
      const select = document.getElementById("select-email-ate");
      const emailAte = select.value;
      if (!emailAte) {
        showStatus("Selecione até qual candidato deseja enviar os e-mails.");
        return;
      }

      const btn = document.getElementById("btn-enviar-emails");
      const spinner = btn.querySelector(".spinner-border");
      const label = btn.querySelector("span:last-child");
      btn.disabled = true; spinner.classList.remove("d-none"); label.textContent = "Enviando...";

      try {
        let resp = await fetchComToken(`/backend/editais/enviar_emails/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ enviar_ate: emailAte }),
        });

        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken(`/backend/editais/enviar_emails/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ enviar_ate: emailAte }),
          });
        }

        const result = await resp.json().catch(() => ({}));
        if (!resp.ok) throw new Error(result.detail || "Erro ao enviar e-mails em massa.");

        const qtd = result.numero_emails_enviados ?? 0;
        const ultimo = result.nome_ultima_pessoa_que_o_email_foi_enviado ?? "-";
        showStatus(`E-mails enviados com sucesso: ${qtd}. Último enviado: ${ultimo}.`, "success");
      } catch (e) {
        showStatus(e.message || "Falha ao enviar e-mails em massa.");
      } finally {
        btn.disabled = false; spinner.classList.add("d-none"); label.textContent = "Enviar e-mails";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      if (!token) return logout();

      carregarCandidatos();
      document.getElementById("btn-enviar-emails").addEventListener("click", enviarEmailsLote);
    });
  </script>
</body>

</html>