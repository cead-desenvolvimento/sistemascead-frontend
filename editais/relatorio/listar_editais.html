<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatórios de Editais</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="../../extra/css/principal.css" />
</head>

<body>
  <div class="container py-5">

    <div class="row mb-4 align-items-center">
      <div class="col">
        <h1 class="h2 mb-0">
          <i class="bi bi-journal-text me-2"></i>Relatórios de Editais
        </h1>
      </div>
      <div class="col-auto d-flex gap-2">
        <a href="/" class="btn btn-outline-primary">
          <i class="bi bi-list me-1"></i> Menu
        </a>
        <button class="btn btn-outline-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right me-1"></i> Sair
        </button>
      </div>
    </div>

    <div id="status" class="alert d-none" role="alert"></div>

    <div class="table-responsive shadow-sm">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-center">Edital</th>
            <th class="text-center">Validade</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody id="editais-body">
          <tr>
            <td colspan="4" class="text-center py-4 text-muted">Carregando editais...</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <script src="../../extra/js/logout.js"></script>
  <script src="../../extra/js/fetchComToken.js"></script>
  <script src="../../extra/js/refreshAccessToken.js"></script>
  <script>
    function showStatus(msg, type = "danger") {
      const el = document.getElementById("status");
      el.className = `alert alert-${type}`;
      el.textContent = msg;
      el.classList.remove("d-none");
    }
    function clearStatus() {
      const el = document.getElementById("status");
      el.className = "alert d-none";
      el.textContent = "";
    }
    const fmtData = (d) => d ? new Date(d).toLocaleDateString("pt-BR") : "-";

    function showLocalStatus(buttonElement, msg, type = "danger") {
      const statusRow = buttonElement.closest('tr').nextElementSibling;
      const statusEl = statusRow.querySelector('.alert');
      statusEl.className = `alert alert-${type} mt-2 mb-0`;
      statusEl.textContent = msg;
      statusEl.classList.remove('d-none');
    }

    function clearLocalStatus(buttonElement) {
      const statusRow = buttonElement.closest('tr').nextElementSibling;
      const statusEl = statusRow.querySelector('.alert');
      if (statusEl) {
        statusEl.classList.add('d-none');
      }
    }

    async function carregarEditais() {
      const tbody = document.getElementById("editais-body");
      clearStatus();
      tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-muted">Carregando editais...</td></tr>`;

      try {
        let resp = await fetchComToken("/backend/editais/relatorio/listar/editais/", {
          method: "GET",
          credentials: "include",
        });

        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken("/backend/editais/relatorio/listar/editais/", {
            method: "GET",
            credentials: "include",
          });
        }

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.detail || "Erro ao buscar editais.");
        }

        const editais = await resp.json();
        tbody.innerHTML = "";

        if (!Array.isArray(editais) || editais.length === 0) {
          tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-muted">Nenhum edital disponível para envio de mensagem.</td></tr>`;
          return;
        }

        editais.forEach((ed) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${ed.edital_str ?? "-"}</td>
            <td>${fmtData(ed.data_validade)}</td>
            <td class="text-end">
              <div class="d-inline-flex gap-2">
                <button class="btn btn-danger btn-sm" onclick="baixarCSV(event, ${ed.id}, '${ed.edital_str ?? ""}')">
                  <i class="bi bi-download me-1"></i> Todas as vagas
                </button>
                <a class="btn btn-danger btn-sm"
                  href="listar_vagas.html?id=${encodeURIComponent(ed.id)}">
                  <i class="bi bi-eye me-1"></i> Ver vagas
                </a>
              </div>
            </td>
          `;
          tbody.appendChild(tr);

          const statusRow = document.createElement("tr");
          statusRow.innerHTML = `<td colspan="3"><div class="alert mt-2 mb-0 d-none"></div></td>`;
          tbody.appendChild(statusRow);
        });

      } catch (e) {
        showStatus(e.message || "Falha ao carregar editais.");
      }
    }

    async function baixarCSV(event, id, descricao) {
      const button = event.currentTarget;
      clearStatus(); // Limpa o status global
      clearLocalStatus(button); // Limpa o status local

      try {
        let resp = await fetchComToken(`/backend/editais/relatorio/edital/${id}/`, {
          method: "GET",
          headers: { "Accept": "text/csv" },
          credentials: "include",
        });

        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken(`/backend/editais/relatorio/edital/${id}/`, {
            method: "GET",
            headers: { "Accept": "text/csv" },
            credentials: "include",
          });
        }

        if (!resp.ok) {
          throw new Error("Erro ao baixar o CSV.");
        }

        const blob = await resp.blob();
        const text = await blob.text();
        if (text.trim().length === 0) {
          showLocalStatus(button, "Não há inscritos para gerar o relatório deste edital.", "warning");
          return;
        }

        const url = URL.createObjectURL(blob);

        // nome de arquivo amigável
        const slug = (descricao || "").toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "_").replace(/^_|_$/g, "");
        const filename = `relatorio_edital${slug ? "_" + slug : ""}.csv`;

        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        showStatus(e.message || "Falha ao baixar CSV.");
      }
    }


    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      if (!token) return logout();
      carregarEditais();
    });
  </script>
</body>

</html>