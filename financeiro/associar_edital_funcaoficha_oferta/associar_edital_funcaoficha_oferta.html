<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Associação de Edital, Função e Oferta</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="../../extra/css/principal.css" />
</head>

<body>
  <div class="container py-5">

    <!-- Cabeçalho -->
    <div class="row mb-4 align-items-center">
      <div class="col">
        <h1 class="h2 mb-0">
          <i class="bi bi-link-45deg me-2"></i>Associar Edital, Função e Oferta
        </h1>
      </div>
      <div class="col-auto d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="window.location.href='/'">
          <i class="bi bi-list me-1"></i> Menu
        </button>
        <button class="btn btn-outline-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right me-1"></i> Sair
        </button>
      </div>
    </div>

    <!-- Alert -->
    <div id="error-message" class="alert alert-dismissible d-none" role="alert">
      <span id="error-text"></span>
      <button type="button" class="btn-close" aria-label="Fechar" onclick="dismissError()"></button>
    </div>

    <!-- Formulário -->
    <div class="card mb-4" id="form-container">
      <div class="card-header bg-success text-white" id="form-header">
        <i class="bi bi-plus-circle me-1"></i>
        <span id="form-title">Nova Associação</span>
      </div>
      <div class="card-body">
        <form id="associacao-form">
          <input type="hidden" id="associacao-id" />
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label for="edital" class="form-label">Edital</label>
              <select id="edital" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label for="funcao" class="form-label">Função</label>
              <select id="funcao" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label for="oferta" class="form-label">Oferta</label>
              <select id="oferta" class="form-select"></select>
            </div>
            <div class="col-12 text-end mt-3">
              <button type="button" class="btn btn-outline-secondary me-2 d-none" id="cancel-button"
                onclick="cancelarEdicao()">
                <i class="bi bi-x-circle"></i> Cancelar
              </button>
              <button type="submit" class="btn btn-danger">
                <i class="bi bi-save me-1"></i><span id="submit-text">Adicionar</span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Lista -->
    <div class="mb-3">
      <h2 class="h4 mb-2">
        <i class="bi bi-list-ul me-2"></i> Associações Existentes
      </h2>
    </div>
    <div class="table-responsive shadow-sm">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-center">Edital</th>
            <th class="text-center">Função</th>
            <th class="text-center">Oferta</th>
            <th class="text-center">Ações</th>
          </tr>
        </thead>
        <tbody id="lista-associacoes">
          <tr>
            <td colspan="4" class="text-center py-4 text-muted">Carregando dados...</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- Scripts -->
  <script src="../../extra/js/logout.js"></script>
  <script src="../../extra/js/fetchComToken.js"></script>
  <script src="../../extra/js/refreshAccessToken.js"></script>
  <script>
    let editMode = false;
    let currentId = null;

    function showError(msg, isSuccess = false, type = null) {
      const errorDiv = document.getElementById("error-message");
      const errorText = document.getElementById("error-text");
      const alertType = type || (isSuccess ? "success" : "danger");
      errorDiv.className = `alert alert-${alertType} alert-dismissible`;
      errorText.textContent = msg;
      errorDiv.classList.remove("d-none");
      if (isSuccess) setTimeout(dismissError, 4000);
    }

    function dismissError() {
      document.getElementById("error-message").classList.add("d-none");
    }

    function populateSelect(selectElement, items, labelField, placeholder = "Selecione...") {
      selectElement.innerHTML = `<option value="">${placeholder}</option>`;
      items.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item[labelField] || item.nome || item.descricao || item.funcao || item.oferta;
        selectElement.appendChild(option);
      });
    }

    async function carregarSelects() {
      try {
        let [rEditais, rFuncoes, rOfertas] = await Promise.all([
          fetchComToken("/backend/financeiro/listar_editais_atuais/"),
          fetchComToken("/backend/financeiro/listar_funcoes_com_ficha_uab/"),
          fetchComToken("/backend/financeiro/listar_ofertas_atuais/"),
        ]);

        // refresh se necessário (basta um 401 para refazer o trio)
        if (rEditais.status === 401 || rFuncoes.status === 401 || rOfertas.status === 401) {
          await refreshAccessToken();
          [rEditais, rFuncoes, rOfertas] = await Promise.all([
            fetchComToken("/backend/financeiro/listar_editais_atuais/"),
            fetchComToken("/backend/financeiro/listar_funcoes_com_ficha_uab/"),
            fetchComToken("/backend/financeiro/listar_ofertas_atuais/"),
          ]);
        }

        let hasWarning = false;

        const editais = rEditais.ok ? await rEditais.json() : (hasWarning = true, []);
        const funcoes = rFuncoes.ok ? await rFuncoes.json() : (hasWarning = true, []);
        const ofertas = rOfertas.ok ? await rOfertas.json() : (hasWarning = true, []);

        populateSelect(document.getElementById("edital"), editais, "descricao", "Selecione um Edital");
        populateSelect(document.getElementById("funcao"), funcoes, "funcao", "Selecione uma Função");
        populateSelect(document.getElementById("oferta"), ofertas, "oferta", "— Sem oferta —");

        if (hasWarning) {
          showError("Alguns dados podem não estar disponíveis no momento.", false, "warning");
        }

        if (editMode) verificarCamposIncompletos();
      } catch (error) {
        showError(`Falha ao carregar opções: ${error.message}`);
      }
    }

    function verificarCamposIncompletos() {
      const edital = document.getElementById("edital");
      const funcao = document.getElementById("funcao");
      const oferta = document.getElementById("oferta");

      const incompletos = [];
      if (edital.value === "" && edital.getAttribute("data-expected-value")) incompletos.push("edital");
      if (funcao.value === "" && funcao.getAttribute("data-expected-value")) incompletos.push("função");
      if (oferta.value === "" && oferta.getAttribute("data-expected-value")) incompletos.push("oferta");

      if (incompletos.length > 0) {
        showError("Não foi possível recuperar completamente a associação (edital/funcão/oferta possivelmente inativos).", false, "warning");
        return true;
      }
      return false;
    }

    async function carregarAssociacoes() {
      const tabela = document.getElementById("lista-associacoes");
      try {
        let resp = await fetchComToken("/backend/financeiro/associar_edital_funcao_oferta/");
        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken("/backend/financeiro/associar_edital_funcao_oferta/");
        }
        if (!resp.ok) throw new Error("Erro ao buscar associações");

        const associacoes = await resp.json();
        tabela.innerHTML = "";

        if (!associacoes.length) {
          tabela.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">Nenhuma associação encontrada.</td></tr>`;
          return;
        }

        associacoes.forEach((a) => {
          const row = document.createElement("tr");
          row.dataset.id = a.id;
          row.dataset.edital = a.ed_edital;
          row.dataset.funcao = a.fi_funcao_bolsista;
          row.dataset.oferta = (a.ac_curso_oferta ?? "");
          row.innerHTML = `
            <td class="text-center">${a.edital}</td>
            <td class="text-center">${a.funcao}</td>
            <td class="text-center">${a.oferta ?? "—"}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary me-2" onclick="editarAssociacaoFromRow(this)">
                <i class="bi bi-pencil-square"></i> Editar
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="excluirAssociacao(this)">
                <i class="bi bi-trash"></i> Excluir
              </button>
            </td>
          `;
          tabela.appendChild(row);
        });
      } catch (error) {
        showError(error.message);
      }
    }

    function editarAssociacaoFromRow(button) {
      const row = button.closest("tr");
      setarValoresEdicao(row.dataset.id, row.dataset.edital, row.dataset.funcao, row.dataset.oferta);
    }

    function setarValoresEdicao(id, editalId, funcaoId, ofertaId) {
      editMode = true;
      currentId = id;

      const editalSelect = document.getElementById("edital");
      const funcaoSelect = document.getElementById("funcao");
      const ofertaSelect = document.getElementById("oferta");

      // normaliza valor vindo da lista (null, "null", undefined, "")
      const toOptionValue = (v) => {
        if (v === null || v === undefined) return "";
        const s = String(v).trim();
        return (s === "" || s === "null" || s === "undefined") ? "" : s;
      };

      // seta o select; se a opção ainda não existe, guarda em data-expected-value
      const setSelectValue = (select, value) => {
        if (!select) return;
        const clean = toOptionValue(value);

        // limpa estado anterior
        select.classList.remove("is-invalid");
        const fb = select?.nextElementSibling;
        if (fb && fb.classList?.contains("invalid-feedback")) fb.textContent = "";

        // remove expected antigo
        select.removeAttribute("data-expected-value");

        if (clean === "") { // valor nulo/ausente
          select.value = "";
          return;
        }

        const hasOption = Array.from(select.options).some((opt) => opt.value === clean);
        if (hasOption) {
          select.value = clean;
        } else {
          // ainda não carregou as options -> marca para preencher depois
          select.setAttribute("data-expected-value", clean);
          select.value = ""; // evita ficar com valor inválido selecionado
        }
      };

      // aplica valores
      setSelectValue(editalSelect, editalId);
      setSelectValue(funcaoSelect, funcaoId);
      setSelectValue(ofertaSelect, ofertaId); // pode ser "" (null) e tá tudo certo

      // ---- UI de modo edição ----
      // título
      const titleEl = document.getElementById("form-title");
      if (titleEl) titleEl.textContent = "Editar associação";

      // header (muda cor para aviso)
      const headerEl = document.getElementById("form-header");
      if (headerEl) {
        headerEl.classList.remove("bg-success", "text-white");
        headerEl.classList.add("bg-warning", "text-dark");
      }

      // botão salvar -> "Atualizar"
      const submitText = document.getElementById("submit-text");
      if (submitText) submitText.textContent = "Atualizar";

      // mostra botão "Cancelar"
      const cancelBtn = document.getElementById("cancel-button");
      if (cancelBtn) cancelBtn.classList.remove("d-none");

      // tenta resolver imediatamente os expected se as options já estiverem presentes
      [editalSelect, funcaoSelect, ofertaSelect].forEach((sel) => {
        if (!sel) return;
        const expected = sel.getAttribute("data-expected-value");
        if (expected && Array.from(sel.options).some((o) => o.value === expected)) {
          sel.value = expected;
          sel.removeAttribute("data-expected-value");
        }
      });
    }

    async function excluirAssociacao(button) {
      const row = button.closest("tr");
      const id = row.dataset.id;
      if (!confirm("Tem certeza que deseja excluir esta associação?")) return;

      try {
        let resp = await fetchComToken(`/backend/financeiro/associar_edital_funcao_oferta/id/${id}/`, { method: "DELETE" });
        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken(`/backend/financeiro/associar_edital_funcao_oferta/id/${id}/`, { method: "DELETE" });
        }
        if (!resp.ok) {
          const errorData = await resp.json().catch(() => ({}));
          throw new Error(errorData.detail || "Erro ao excluir associação");
        }
        showError("Associação excluída com sucesso!", true);
        await carregarAssociacoes();
      } catch (error) {
        showError(error.message);
      }
    }

    function cancelarEdicao() {
      editMode = false;
      currentId = null;

      document.getElementById("associacao-form").reset();
      document.getElementById("associacao-id").value = "";

      ["edital", "funcao", "oferta"].forEach(id => document.getElementById(id).removeAttribute("data-expected-value"));

      document.getElementById("form-title").textContent = "Nova Associação";
      document.getElementById("submit-text").textContent = "Adicionar";
      document.getElementById("cancel-button").classList.add("d-none");

      // reverte classes do modo edição
      document.getElementById("form-container").classList.remove("border", "border-success", "shadow-sm");
      const header = document.getElementById("form-header");
      header.classList.remove("bg-warning", "text-dark");
      header.classList.add("bg-success", "text-white");

      dismissError();
    }

    function toIntOrNull(v) {
      if (v === undefined || v === null) return null;
      const s = String(v).trim();
      return s === "" ? null : parseInt(s, 10);
    }

    async function salvarAssociacao(event) {
      event.preventDefault();

      const editalVal = document.getElementById("edital").value;
      const funcaoVal = document.getElementById("funcao").value;
      const ofertaVal = document.getElementById("oferta").value;

      const dados = {
        ed_edital: toIntOrNull(editalVal),
        fi_funcao_bolsista: toIntOrNull(funcaoVal),
        ac_curso_oferta: toIntOrNull(ofertaVal),
      };
      if (editMode) dados.id = toIntOrNull(currentId);

      const url = "/backend/financeiro/associar_edital_funcao_oferta/";
      const method = editMode ? "PUT" : "POST";

      try {
        let resp = await fetchComToken(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dados),
        });

        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dados),
          });
        }

        if (!resp.ok) {
          const result = await resp.json().catch(() => ({}));
          const errorMsg =
            result.detail ||
            result.non_field_errors?.join(", ") ||
            `Erro ao ${editMode ? "atualizar" : "criar"} associação`;
          throw new Error(errorMsg);
        }

        showError(`Associação ${editMode ? "atualizada" : "criada"} com sucesso!`, true);
        cancelarEdicao();
        await carregarAssociacoes();
      } catch (error) {
        showError(error.message);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      if (!token) {
        logout();
        return;
      }
      document.getElementById("associacao-form").addEventListener("submit", salvarAssociacao);
      carregarAssociacoes();
      carregarSelects();
    });
  </script>
</body>

</html>