<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Últimas Fichas (Atualização de Vínculo)</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="../../extra/css/principal.css" />
</head>

<body>
  <div class="container py-5">

    <!-- Cabeçalho -->
    <div class="row mb-4 align-items-center">
      <div class="col">
        <h1 class="h2 mb-0">
          <i class="bi bi-calendar-check me-2"></i>Atualização de Vínculo
        </h1>
      </div>
      <div class="col-auto d-flex gap-2">
        <a href="menu.html" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i> Voltar
        </a>
        <button class="btn btn-outline-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right me-1"></i> Sair
        </button>
      </div>
    </div>

    <!-- Alert -->
    <div id="error-message" class="alert d-none" role="alert"></div>

    <!-- Tabela -->
    <div class="table-responsive shadow-sm">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Nome</th>
            <th>Edital</th>
            <th>Início</th>
            <th>Fim</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody id="lista-bolsistas">
          <tr>
            <td colspan="5" class="text-center py-4 text-muted">
              Carregando dados...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- Scripts -->
  <script src="../../extra/js/logout.js"></script>
  <script src="../../extra/js/fetchComToken.js"></script>
  <script src="../../extra/js/refreshAccessToken.js"></script>
  <script>
    async function carregarBolsistas() {
      const tabela = document.getElementById("lista-bolsistas");
      const errorDiv = document.getElementById("error-message");

      tabela.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Carregando dados...</td></tr>`;
      errorDiv.className = "alert d-none";
      errorDiv.textContent = "";

      try {
        let response = await fetchComToken("/backend/financeiro/bolsistas/", {
          method: "GET",
          credentials: "include",
        });

        if (response.status === 401) {
          await refreshAccessToken();
          response = await fetchComToken("/backend/financeiro/bolsistas/", {
            method: "GET",
            credentials: "include",
          });
        }

        if (!response.ok) throw new Error("Erro ao buscar bolsistas");

        const bolsistas = await response.json();
        tabela.innerHTML = "";

        if (!Array.isArray(bolsistas) || bolsistas.length === 0) {
          tabela.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Nenhum bolsista encontrado.</td></tr>`;
          return;
        }

        bolsistas.forEach((b) => {
          const inicioId = `inicio-${b.id}`;
          const fimId = `fim-${b.id}`;
          const btnId = `btn-${b.id}`;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${b.nome}</td>
            <td>${b.edital}</td>
            <td><input type="date" class="form-control form-control-sm" value="${b.data_inicio_vinculacao || ""}" id="${inicioId}" /></td>
            <td><input type="date" class="form-control form-control-sm" value="${b.data_fim_vinculacao || ""}" id="${fimId}" /></td>
            <td class="text-end">
              <button class="btn btn-sm btn-success" id="${btnId}">
                <span class="btn-text"><i class="bi bi-check-circle"></i> Atualizar</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              </button>
            </td>
          `;
          tabela.appendChild(row);

          document.getElementById(btnId).addEventListener("click", () => atualizarDatas(b.id, inicioId, fimId, btnId));
        });
      } catch (error) {
        showError(error.message);
      }
    }

    async function atualizarDatas(id, inicioId, fimId, btnId) {
      const data_inicio = document.getElementById(inicioId).value || null;
      const data_fim = document.getElementById(fimId).value || null;

      const botao = document.getElementById(btnId);
      const textSpan = botao.querySelector(".btn-text");
      const spinner = botao.querySelector(".spinner-border");
      const originalText = textSpan.innerHTML;

      textSpan.innerHTML = `Salvando...`;
      spinner.classList.remove("d-none");
      botao.disabled = true;

      try {
        let response = await fetchComToken("/backend/financeiro/bolsista/atualizar/", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id,
            data_inicio_vinculacao: data_inicio,
            data_fim_vinculacao: data_fim || null,
          }),
        });

        if (response.status === 401) {
          await refreshAccessToken();
          response = await fetchComToken("/backend/financeiro/bolsista/atualizar/", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id,
              data_inicio_vinculacao: data_inicio,
              data_fim_vinculacao: data_fim || null,
            }),
          });
        }

        const result = await response.json().catch(() => ({}));
        if (!response.ok) {
          const erro = result.detail || (result.non_field_errors && result.non_field_errors.join(" ")) || "Erro ao atualizar";
          throw new Error(erro);
        }

        showError(result.detail || "Atualizado com sucesso", true);
      } catch (error) {
        showError(error.message);
      } finally {
        textSpan.innerHTML = originalText;
        spinner.classList.add("d-none");
        botao.disabled = false;
      }
    }

    function showError(msg, success = false) {
      const div = document.getElementById("error-message");
      div.className = `alert mt-3 ${success ? "alert-success" : "alert-danger"}`;
      div.textContent = msg;
      div.classList.remove("d-none");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("token");
      if (!token) return logout();
      carregarBolsistas();
    });
  </script>
</body>

</html>