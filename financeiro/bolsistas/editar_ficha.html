<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Ficha</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="../../extra/css/principal.css" />
</head>

<body>
    <div class="container py-5">

        <!-- Cabeçalho -->
        <div class="row mb-4 align-items-center">
            <div class="col">
                <h1 class="h2 mb-0">
                    <i class="bi bi-pencil-square me-2"></i>Editar Ficha
                </h1>
            </div>
            <div class="col-auto d-flex gap-2">
                <a href="buscar_bolsista.html" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </a>
                <button class="btn btn-outline-danger" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i> Sair
                </button>
            </div>
        </div>

        <!-- Nome da pessoa -->
        <div class="mb-4">
            <h4 id="nome-pessoa" class="fw-bold text-primary"></h4>
        </div>

        <!-- Alert -->
        <div id="error-message" class="alert d-none" role="alert"></div>

        <!-- Formulário -->
        <form id="form-editar" class="shadow-sm p-4 bg-light rounded">
            <input type="hidden" id="ficha-id" />

            <div class="mb-3">
                <label class="form-label fw-bold">Edital</label>
                <select class="form-select" id="edital"></select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Função</label>
                <select class="form-select" id="funcao"></select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Curso/Oferta</label>
                <select class="form-select" id="curso"></select>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Data Início Vinculação</label>
                    <input type="date" class="form-control" id="data-inicio" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Data Fim Vinculação</label>
                    <input type="date" class="form-control" id="data-fim" />
                </div>
            </div>

            <div class="text-end">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-1"></i> Salvar
                </button>
            </div>
        </form>
    </div>

    <!-- Scripts -->
    <script src="../../extra/js/logout.js"></script>
    <script src="../../extra/js/fetchComToken.js"></script>
    <script src="../../extra/js/refreshAccessToken.js"></script>
    <script>
        async function carregarSelects() {
            // Carregar editais
            let respEditais = await fetchComToken("/backend/financeiro/bolsista/editais/");
            let editais = await respEditais.json();
            const editalSelect = document.getElementById("edital");
            editalSelect.innerHTML = editais.map(e => `<option value="${e.id}">${e.nome}</option>`).join("");

            // Carregar funções
            let respFuncoes = await fetchComToken("/backend/financeiro/bolsista/funcoes/");
            let funcoes = await respFuncoes.json();
            const funcaoSelect = document.getElementById("funcao");
            funcaoSelect.innerHTML = funcoes.map(f => `<option value="${f.id}">${f.nome}</option>`).join("");

            // Carregar ofertas
            let respOfertas = await fetchComToken("/backend/financeiro/bolsista/ofertas/");
            let ofertas = await respOfertas.json();
            const cursoSelect = document.getElementById("curso");
            cursoSelect.innerHTML = ofertas.map(o => `<option value="${o.id}">${o.nome}</option>`).join("");
        }

        async function carregarFicha() {
            const params = new URLSearchParams(window.location.search);
            const fichaId = params.get("id");
            if (!fichaId) {
                showError("ID da ficha não informado.");
                return;
            }
            document.getElementById("ficha-id").value = fichaId;

            try {
                // Carrega selects primeiro
                await carregarSelects();

                let response = await fetchComToken(`/backend/financeiro/bolsista/ficha/${fichaId}/`, {
                    method: "GET",
                    credentials: "include",
                });

                if (response.status === 401) {
                    await refreshAccessToken();
                    response = await fetchComToken(`/backend/financeiro/bolsista/ficha/${fichaId}/`, {
                        method: "GET",
                        credentials: "include",
                    });
                }

                if (!response.ok) throw new Error("Erro ao buscar ficha");

                const ficha = await response.json();

                document.getElementById("nome-pessoa").textContent = ficha.nome || "";

                document.getElementById("edital").value = ficha.edital_id || "";
                document.getElementById("funcao").value = ficha.funcao_id || "";
                document.getElementById("curso").value = ficha.curso_oferta_id || "";

                document.getElementById("data-inicio").value = ficha.data_inicio_vinculacao || "";
                document.getElementById("data-fim").value = ficha.data_fim_vinculacao || "";
            } catch (error) {
                showError(error.message);
            }
        }

        document.getElementById("form-editar").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("ficha-id").value;
            const inicio = document.getElementById("data-inicio").value;
            const fim = document.getElementById("data-fim").value;
            const edital_id = document.getElementById("edital").value;
            const funcao_id = document.getElementById("funcao").value;
            const curso_id = document.getElementById("curso").value;

            try {
                let response = await fetchComToken(`/backend/financeiro/bolsista/atualizar_ficha/`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id,
                        edital_id,
                        funcao_id,
                        curso_oferta_id: curso_id,
                        data_inicio_vinculacao: inicio || null,
                        data_fim_vinculacao: fim || null,
                    }),
                });

                if (response.status === 401) {
                    await refreshAccessToken();
                    response = await fetchComToken(`/backend/financeiro/bolsista/atualizar_ficha/`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            id,
                            edital_id,
                            funcao_id,
                            curso_oferta_id: curso_id,
                            data_inicio_vinculacao: inicio || null,
                            data_fim_vinculacao: fim || null,
                        }),
                    });
                }

                const result = await response.json().catch(() => ({}));
                if (!response.ok) {
                    const erro = result.detail || "Erro ao salvar ficha";
                    throw new Error(erro);
                }

                showError("A ficha foi atualizada", true);
            } catch (error) {
                showError(error.message);
            }
        });

        function showError(msg, success = false) {
            const div = document.getElementById("error-message");
            div.className = `alert mt-3 ${success ? "alert-success" : "alert-danger"}`;
            div.textContent = msg;
            div.classList.remove("d-none");
        }

        document.addEventListener("DOMContentLoaded", carregarFicha);
    </script>
</body>

</html>