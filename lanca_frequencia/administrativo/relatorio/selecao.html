<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <title>Selecionar Frequência</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="../../../extra/css/principal.css" />
</head>

<body>
  <div class="container py-5">

    <!-- Cabeçalho -->
    <div class="row mb-4 align-items-center">
      <div class="col">
        <h1 class="h2 mb-0">
          <i class="bi bi-calendar-week me-2"></i>Selecionar Frequência
        </h1>
      </div>
      <div class="col-auto d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="window.location.href='/'">
          <i class="bi bi-list me-1"></i> Menu
        </button>
        <button class="btn btn-outline-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right me-1"></i> Sair
        </button>
      </div>
    </div>

    <!-- Mensagem -->
    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

    <!-- Lista de frequências -->
    <div class="row g-4" id="frequenciasContainer">
      <div class="text-muted">Carregando frequências...</div>
    </div>

  </div>

  <!-- Scripts -->
  <script src="../../../extra/js/logout.js"></script>
  <script src="../../../extra/js/fetchComToken.js"></script>
  <script src="../../../extra/js/refreshAccessToken.js"></script>
  <script>
    async function carregarFrequencias() {
      const container = document.getElementById("frequenciasContainer");
      const errorMsg = document.getElementById("error-message");

      container.innerHTML = `<div class="text-muted">Carregando frequências...</div>`;
      errorMsg.classList.add("d-none");
      errorMsg.textContent = "";

      try {
        let resp = await fetchComToken("/backend/lanca_frequencia/relatorio_administrativo/", {
          method: "GET",
          credentials: "include",
        });

        if (resp.status === 401) {
          await refreshAccessToken();
          resp = await fetchComToken("/backend/lanca_frequencia/relatorio_administrativo/", {
            method: "GET",
            credentials: "include",
          });
        }

        if (!resp.ok) throw new Error("Erro ao buscar frequências disponíveis.");

        const dados = await resp.json();
        if (!Array.isArray(dados) || dados.length === 0) {
          container.innerHTML = `<div class="alert alert-info m-0">Nenhuma frequência encontrada.</div>`;
          return;
        }

        container.innerHTML = "";
        dados.forEach((freq) => {
          const dataInicio = new Date(freq.data_inicio).toLocaleDateString("pt-BR");
          const dataFim = new Date(freq.data_fim).toLocaleDateString("pt-BR");

          const col = document.createElement("div");
          col.className = "col-md-6 col-lg-4";

          col.innerHTML = `
            <div class="card h-100 shadow-sm">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-2">
                  <i class="bi bi-calendar-event me-2 text-primary"></i>Frequência #${freq.id}
                </h5>
                <p class="card-text text-muted flex-grow-1">${dataInicio} até ${dataFim}</p>
                <a href="relatorio.html?id=${encodeURIComponent(freq.id)}" class="btn btn-danger mt-3 align-self-start">
                  <i class="bi bi-eye me-1"></i> Visualizar
                </a>
              </div>
            </div>
          `;
          container.appendChild(col);
        });

      } catch (err) {
        container.innerHTML = "";
        errorMsg.textContent = err.message;
        errorMsg.classList.remove("d-none");
      }
    }

    document.addEventListener("DOMContentLoaded", carregarFrequencias);
  </script>
</body>

</html>