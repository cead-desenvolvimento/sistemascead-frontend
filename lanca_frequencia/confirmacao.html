<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Confirmação de Frequência</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="../extra/css/principal.css" />
</head>

<body>
    <div class="container py-5">

        <div class="card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="bi bi-check2-circle me-2"></i> Confirmação de Frequência
                </h2>
                <div>
                    <button class="btn btn-outline-danger btn-sm ms-2" onclick="logout()">
                        <i class="bi bi-box-arrow-right me-1"></i> Sair
                    </button>
                </div>
            </div>

            <div id="error-message" class="text-danger fw-bold mt-2 text-center"></div>

            <div id="confirmacao-content" class="mt-4"></div>

            <div class="d-flex justify-content-between mt-4">
                <a href="lancar_frequencia.html" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </a>
                <button id="confirmar-btn" class="btn btn-danger">
                    <i class="bi bi-check-circle me-1"></i> Confirmar
                </button>
            </div>
        </div>

    </div>

    <script src="../extra/js/logout.js"></script>
    <script src="../extra/js/fetchComToken.js"></script>
    <script src="../extra/js/refreshAccessToken.js"></script>
    <script>
        let previewData = null;

        async function carregarConfirmacao() {
            const errorMessage = document.getElementById("error-message");
            const container = document.getElementById("confirmacao-content");
            errorMessage.innerText = "";
            container.innerHTML = "";

            try {
                // Recupera a prévia salva no lancar_frequencia.html
                const data = sessionStorage.getItem("preview-frequencia");
                if (!data) {
                    throw new Error("Nenhum dado de prévia encontrado. Refaça o lançamento.");
                }

                previewData = JSON.parse(data);

                if (previewData.preview && Array.isArray(previewData.preview)) {
                    const table = document.createElement("table");
                    table.classList.add("table", "table-striped", "mt-3");

                    table.innerHTML = `
            <thead>
              <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>Função</th>
                <th>Curso</th>
                <th>Autorizar Pagamento</th>
                <th>Disciplinas</th>
              </tr>
            </thead>
            <tbody>
              ${previewData.preview.map(b => `
                <tr class="${b.autorizar_pagamento ? "table-success" : ""}">
                  <td>${b.nome}</td>
                  <td>${b.cpf}</td>
                  <td>${b.funcao}</td>
                  <td>${b.curso}</td>
                  <td>${b.autorizar_pagamento ? "Sim" : "Não"}</td>
                  <td>${b.disciplinas.length > 0 ? b.disciplinas.join(", ") : "-"}</td>
                </tr>
              `).join("")}
            </tbody>
          `;

                    container.appendChild(table);
                } else {
                    throw new Error("Formato inválido dos dados de prévia.");
                }

            } catch (error) {
                errorMessage.innerText = `Erro: ${error.message}`;
            }
        }

        async function confirmarLancamento() {
            const errorMessage = document.getElementById("error-message");
            errorMessage.innerText = "";

            try {
                if (!previewData) {
                    throw new Error("Nenhum dado para confirmar.");
                }

                const response = await fetchComToken("/backend/lanca_frequencia/", {
                    method: "POST",
                    body: JSON.stringify({
                        bolsistas: previewData.preview.map(p => ({
                            ficha_id: p.ficha_id,
                            autorizar_pagamento: p.autorizar_pagamento,
                            disciplinas: p.disciplinas_ids
                        }))
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || "Erro ao confirmar lançamento da frequência");
                }

                window.location.href = "relatorio.html";
            } catch (error) {
                errorMessage.innerText = `Erro: ${error.message}`;
            }
        }

        document.addEventListener("DOMContentLoaded", carregarConfirmacao);
        document.getElementById("confirmar-btn").addEventListener("click", confirmarLancamento);
    </script>
</body>

</html>