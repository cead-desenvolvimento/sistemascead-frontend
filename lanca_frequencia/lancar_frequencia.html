<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lançar Frequência</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="../extra/css/principal.css" />
</head>

<body>
  <div class="container py-5">

    <!-- Cabeçalho -->
    <div class="row mb-4 align-items-center">
      <div class="col">
        <h1 class="h2 mb-0">
          <i class="bi bi-calendar-check me-2"></i>Lançamento de Frequência
        </h1>
      </div>
      <div class="col-auto d-flex gap-2">
        <a href="relatorio.html" class="btn btn-outline-info">
          <i class="bi bi-bar-chart-line me-1"></i> Relatório
        </a>
        <button class="btn btn-outline-danger" onclick="logout()">
          <i class="bi bi-box-arrow-right me-1"></i> Sair
        </button>
      </div>
    </div>

    <!-- Mensagem de erro topo -->
    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

    <!-- Formulário -->
    <form id="frequencia-form">
      <div id="cursos-container"></div>
      <div id="error-message-bottom" class="alert alert-danger d-none mt-3" role="alert"></div>
      <button type="submit" class="btn btn-danger btn-lg w-100 mt-4">
        <i class="bi bi-check-circle me-1"></i> Enviar Frequência
      </button>
    </form>

  </div>

  <!-- Scripts -->
  <script src="../extra/js/logout.js"></script>
  <script src="../extra/js/fetchComToken.js"></script>
  <script src="../extra/js/refreshAccessToken.js"></script>
  <script>
    let cursoData;

    async function carregarFichas() {
      const errorMessage = document.getElementById("error-message");
      errorMessage.classList.add("d-none");
      errorMessage.textContent = "";
      atualizarEstadoBotao();

      try {
        const response = await fetchComToken("/backend/lanca_frequencia/");

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          const mensagem = errorData?.detail || "Erro ao buscar fichas.";
          errorMessage.textContent = mensagem;
          errorMessage.classList.remove("d-none");
          atualizarEstadoBotao();
          return;
        }

        cursoData = await response.json();
        const container = document.getElementById("cursos-container");
        container.innerHTML = "";

        cursoData.forEach((curso, index) => {
          const blocoCurso = document.createElement("div");
          blocoCurso.classList.add("mb-5");

          const titulo = document.createElement("h4");
          titulo.textContent = `Curso: ${curso.curso.nome}`;
          blocoCurso.appendChild(titulo);

          const tabela = document.createElement("table");
          tabela.classList.add("table", "table-striped", "align-middle");

          tabela.innerHTML = `
            <thead class="table-dark">
              <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>Função</th>
                <th>Autorizar Pagamento</th>
                <th>Disciplinas Ministradas</th>
              </tr>
            </thead>
            <tbody id="bolsistas-list-${index}"></tbody>
          `;

          blocoCurso.appendChild(tabela);
          container.appendChild(blocoCurso);

          const corpoTabela = document.getElementById(`bolsistas-list-${index}`);
          curso.bolsistas.forEach((bolsista) => {
            const disciplinasOptions = curso.disciplinas_do_curso
              .map((disciplina) => {
                const isSelected = bolsista.disciplinas.includes(disciplina.id);
                return `<option value="${disciplina.id}" ${isSelected ? "selected" : ""}>${disciplina.nome}</option>`;
              })
              .join("");

            const row = `
              <tr>
                <td>${bolsista.cm_pessoa}</td>
                <td>${bolsista.cpf}</td>
                <td>${bolsista.fi_funcao_bolsista}</td>
                <td><input type="checkbox" id="pagamento-${bolsista.id}"></td>
                <td>
                  <select id="disciplinas-${bolsista.id}" multiple class="form-select">
                    ${disciplinasOptions}
                  </select>
                </td>
              </tr>
            `;
            corpoTabela.insertAdjacentHTML("beforeend", row);
          });
        });

        atualizarEstadoBotao();
      } catch (error) {
        errorMessage.textContent = error?.message || "Erro inesperado ao buscar dados.";
        errorMessage.classList.remove("d-none");
        atualizarEstadoBotao();
      }
    }

    document.getElementById("frequencia-form").addEventListener("submit", async function (e) {
      e.preventDefault();
      const errorMessage = document.getElementById("error-message");
      const errorMessageBottom = document.getElementById("error-message-bottom");
      errorMessage.classList.add("d-none");
      errorMessageBottom.classList.add("d-none");
      atualizarEstadoBotao();

      const bolsistasData = cursoData.flatMap((curso) =>
        curso.bolsistas.map((bolsista) => ({
          ficha_id: bolsista.id,
          autorizar_pagamento: document.getElementById(`pagamento-${bolsista.id}`).checked,
          disciplinas: Array.from(
            document.getElementById(`disciplinas-${bolsista.id}`).selectedOptions
          ).map((option) => parseInt(option.value)),
        }))
      );

      try {
        const response = await fetchComToken("/backend/lanca_frequencia/", {
          method: "POST",
          body: JSON.stringify({ bolsistas: bolsistasData }),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || "Erro ao lançar frequência");
        }

        window.location.href = "relatorio.html";
      } catch (error) {
        errorMessageBottom.textContent = `Erro: ${error.message}`;
        errorMessageBottom.classList.remove("d-none");
        atualizarEstadoBotao();
      }
    });

    function atualizarEstadoBotao() {
      const temErro = document.querySelectorAll("#error-message:not(.d-none), #error-message-bottom:not(.d-none)").length > 0;
      const botao = document.querySelector('#frequencia-form button[type="submit"]');
      botao.disabled = temErro;
    }

    document.addEventListener("DOMContentLoaded", carregarFichas);
  </script>
</body>

</html>